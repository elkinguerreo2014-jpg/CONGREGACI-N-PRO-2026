<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Congregaci√≥n Pro - v52 Din√°mica</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --bg-body: #f3f4f6;
            --surface: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --border-light: #e5e7eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --info: #3b82f6; --cloud: #8b5cf6;
            --radius-md: 16px; --radius-sm: 10px;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; font-size: 14px; margin: 0; }

        /* HEADER */
        header.top { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-light); padding: 0.8rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 1.15rem; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -0.5px; }
        
        /* TABS */
        .tabs-container { background: var(--surface); border-bottom: 1px solid var(--border-light); padding: 0 1.5rem; position: sticky; top: 60px; z-index: 90; overflow-x: auto; white-space: nowrap; }
        .tabs-container::-webkit-scrollbar { height: 0px; background: transparent; }
        .tabs { display: flex; gap: 20px; }
        .tabs button { padding: 14px 4px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .tabs button:hover { color: var(--primary); }
        .tabs button.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* UI ELEMENTS */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--surface); border-radius: var(--radius-md); padding: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); margin-bottom: 1.5rem; }
        .card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.2rem; color: var(--text-main); border-bottom: 1px solid var(--border-light); padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }

        .count-badge { background: #f3f4f6; color: var(--text-muted); padding: 2px 10px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; margin-left: 8px; }

        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
        input:not([type="checkbox"]), select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-size: 0.95rem; transition: 0.2s; background: #fff; color: var(--text-main); }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 16px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; border: none; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn.primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        .btn.success { background: var(--success); color: white; }
        .btn.danger { background: var(--danger); color: white; }
        .btn.warning { background: var(--warning); color: white; }
        .btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border-light); }
        .btn.ghost:hover { background: var(--bg-body); color: var(--text-main); }

        .admin-tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; background: #f9fafb; padding: 1.2rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border-light); }
        
        .table-container { border-radius: var(--radius-md); border: 1px solid var(--border-light); overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; }
        .table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .table th { background: #f9fafb; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; padding: 12px 16px; text-align: left; text-transform: uppercase; border-bottom: 1px solid var(--border-light); white-space: nowrap; }
        .table td { padding: 12px 16px; border-bottom: 1px solid var(--border-light); color: var(--text-main); font-size: 0.9rem; }
        .table tbody tr:hover { background-color: #f8fafc; }
        .row-sacado td { color: var(--text-muted); text-decoration: line-through; background: #fef2f2; }

        /* DASHBOARD GRID */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .dash-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border-light); transition: 0.2s; display: flex; flex-direction: column; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .dash-header { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .dash-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; flex: 1; }
        .dash-stat { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dash-num { font-size: 1.8rem; font-weight: 800; line-height: 1.2; margin-bottom: 4px; color: var(--text-main); }
        .dash-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        .num-blue { color: var(--primary); } .num-green { color: var(--success); } .num-orange { color: var(--warning); } .num-purple { color: #8b5cf6; }

        .asist-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 15px; }
        
        #roleBadge { background: #e0e7ff; color: #4338ca; font-weight: 700; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; text-transform: uppercase; }
        #statusIndicator { font-size: 0.75rem; font-weight: bold; padding: 4px 10px; border-radius: 20px; transition: 0.3s; }
        .status-sync { background: #dcfce7; color: #166534; }
        .status-offline { background: #fee2e2; color: #991b1b; }

        #toast { position: fixed; top: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 24px; border-radius: 10px; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; z-index: 2000; border-left: 4px solid #10b981; }
        
        /* SETTINGS MODAL */
        #modalAuth, #modalPwd, #modalSettings { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .settings-card { width: 420px; max-width: 100%; background: var(--surface); border-radius: 20px; box-shadow: var(--shadow-md); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .settings-header { padding: 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; }
        .settings-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .settings-group { border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden; }
        .settings-group summary { padding: 15px; background: #fafafa; font-weight: 600; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); font-size: 0.95rem; }
        .settings-content { padding: 15px; border-top: 1px solid var(--border-light); background: white; }
        .status-card { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .status-card.offline { background: #fef2f2; border-color: #fecaca; }
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 1px solid var(--border-light); border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; color: var(--text-main); text-align: center; gap: 5px; }
        .icon-btn:hover { background: #f9fafb; border-color: var(--primary); }

        #preview-viewport, #s88-preview-viewport { padding: 20px; background: #525252; display:flex; flex-direction:column; align-items:center; margin-top: 20px; border-radius: 8px; }
        .print-canvas { width: 190mm; min-width: 190mm; background: #ffffff !important; color: #000; padding: 10mm; font-family: 'Inter', sans-serif; page-break-after: always; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .official-table { width: 100%; border-collapse: collapse !important; border: 1.5px solid #000 !important; margin-top: 5px; }
        .official-table th, .official-table td { border: 1.2px solid #000 !important; padding: 4px; font-size: 8.5pt; text-align: center; color: #000; }
        
        #app-content { display: none; }
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.3s ease; }
        body.role-restricted .admin-only { display: none !important; }
        body.role-restricted .tabs button:not([data-tab="actividad"]) { display: none !important; }
        
        body.role-admin .restricted-only { display: none !important; }
        .guide-step { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--border-light); }
        .guide-step:last-child { border: none; }
        .guide-step b { color: var(--primary); }

        @media (max-width: 768px) {
            header.top { flex-direction: column; align-items: stretch; gap: 12px; }
            .tabs-container { top: 115px; } 
            .admin-tools-grid, .asist-grid-layout, .stat-grid, .dash-grid { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>

<div id="toast" style="position: fixed; top: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 24px; border-radius: 10px; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; z-index: 2000; border-left: 4px solid #10b981;"></div>

<div id="modalAuth" style="display: flex;">
    <div class="card" style="width:360px; max-width:90%; text-align:center; margin-bottom:0; padding: 40px 20px;">
        <div style="background:var(--primary); width:60px; height:60px; border-radius:16px; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center; color:white; font-size:1.8rem;">üîê</div>
        <h2 style="font-weight:800; margin-bottom:10px; color:var(--text-main);">Bienvenido</h2>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:30px;">Introduce tu clave de acceso.<br><small style="opacity:0.7;">(Clave inicial sugerida: 12345)</small></p>
        <input type="password" id="mPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; font-size:2rem; letter-spacing:12px; margin-bottom:30px; font-weight:700; border-radius: 12px; padding: 15px;">
        <button class="btn primary" id="mEnter" onclick="window.attemptLogin()" style="width:100%; padding:16px; font-size:1rem;">ENTRAR AL SISTEMA</button>
    </div>
</div>

<div id="modalSettings">
    <div class="settings-card">
        <div class="settings-header">
            <h3 style="margin:0; font-size: 1.2rem;">‚öôÔ∏è Ajustes</h3>
            <button class="btn ghost" onclick="closeSettings()" style="padding:6px 12px; border-radius:50%; border:none; font-size:1.2rem;">‚úï</button>
        </div>
        <div class="settings-body">
            
            <details class="settings-group">
                <summary>üìö Ayuda y Tutoriales</summary>
                <div class="settings-content" style="font-size: 0.9rem; color: var(--text-main);">
                    <div class="admin-only" style="background: #eef2ff; border: 1px solid #c7d2fe; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">üëë Gu√≠a: C√≥mo activar Encargados</h4>
                        <div class="guide-step">
                            <b>Paso 1:</b> En "Gesti√≥n de Accesos" (abajo), define la cantidad total de grupos y sus claves.
                        </div>
                        <div class="guide-step">
                            <b>Paso 2:</b> Aseg√∫rate de que tu Nube est√© conectada (luz verde arriba).
                        </div>
                        <div class="guide-step">
                            <b>Paso 3:</b> Env√≠a este mensaje al encargado por WhatsApp:
                            <p style="font-size: 0.8rem; background: white; padding: 8px; border-radius: 4px; margin-top: 5px; border: 1px solid #e5e7eb;">
                                "Hno, entra a: [TU_LINK]<br>
                                En Ajustes > Nube pega esto:<br>
                                API Key: [TU_API_KEY]<br>
                                Project ID: [TU_PROJECT_ID]<br>
                                Dale 'Conectar'. Luego entra con clave: [CLAVE_GRUPO]"
                            </p>
                        </div>
                    </div>

                    <h4 style="margin: 0 0 10px 0; font-size: 0.9rem;">üöÄ Gu√≠a de Uso R√°pido</h4>
                    <ul style="padding-left: 20px; margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                        <li style="margin-bottom: 5px;">Selecciona el <b>Mes y A√±o</b> arriba.</li>
                        <li style="margin-bottom: 5px;">En la pesta√±a <b>Informes</b>, marca casillas y anota horas.</li>
                        <li style="margin-bottom: 5px;">Dale al bot√≥n <b>üíæ Guardar Cambios</b> antes de salir.</li>
                        <li>Si no tienes internet, los datos se guardan en tu celular y se suben cuando conectes.</li>
                    </ul>
                </div>
            </details>

            <div class="settings-group">
                <div style="padding:15px;">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">‚òÅÔ∏è Estado de Sincronizaci√≥n</div>
                    <div id="cloudStatusCard" class="status-card offline">
                        <div class="status-icon" id="cloudIcon">‚ö°</div>
                        <div class="status-text"><h4 id="cloudTitle">Modo Local</h4><p id="cloudDesc">Datos solo en este dispositivo.</p></div>
                    </div>
                    <details>
                        <summary style="padding:0; background:none; color:var(--primary); font-size:0.85rem;">üîß Configurar conexi√≥n...</summary>
                        <div class="settings-content" style="border:none; padding:15px 0 0 0;">
                            <div style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid var(--border-light); font-size:0.85rem;">
                                <p style="margin:0 0 10px 0;">Ingresa tus credenciales de Firebase para sincronizar:</p>
                                <input type="text" id="fbApiKey" placeholder="API Key" value="" style="margin-bottom:10px;">
                                <input type="text" id="fbProjectId" placeholder="Project ID" value="" style="margin-bottom:10px;">
                                <button class="btn primary" onclick="saveCloudCredentials()" style="width:100%;">Conectar</button>
                                <details style="margin-top:10px;">
                                    <summary style="font-size:0.8rem; color:var(--text-muted);">‚ùì ¬øC√≥mo obtengo estos datos?</summary>
                                    
                                    <div class="admin-only">
                                        <ol style="padding-left:20px; color:var(--text-muted); margin:5px 0;">
                                            <li>Crea proyecto en <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a>.</li>
                                            <li>Crea Database en <b>Modo Prueba</b>.</li>
                                            <li>Crea App Web y copia <b>apiKey</b> y <b>projectId</b>.</li>
                                        </ol>
                                    </div>

                                    <div class="restricted-only">
                                        <p style="padding:10px; background:#fff7ed; border-left:3px solid var(--warning); color:var(--text-muted); margin:5px 0; font-size:0.85rem;">
                                            ‚ö†Ô∏è <b>No crees una cuenta nueva.</b><br>
                                            P√≠dele al Secretario/Administrador las claves (API Key y Project ID) para conectarte a la base de datos de tu congregaci√≥n.
                                        </p>
                                    </div>

                                </details>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            <div class="settings-group">
                <div style="padding:15px;">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">üíæ Copias de Seguridad</div>
                    <div class="action-row">
                        <div class="icon-btn" onclick="exportBackup()"><span>üì•</span><small>Descargar</small></div>
                        <div class="icon-btn" style="position:relative;"><span>üì§</span><small>Restaurar</small><input type="file" accept=".json,application/json" onchange="window.importData(this)" style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;"></div>
                    </div>
                </div>
            </div>
            <details class="settings-group admin-only">
                <summary>üîê Gesti√≥n de Accesos</summary>
                <div class="settings-content">
                    <label>Cambiar Clave Administrador</label>
                    <button class="btn warning" style="width:100%; margin-bottom:20px;" onclick="$('#modalPwd').style.display='flex'">üîë Cambiar Clave Principal</button>
                    
                    <div style="border-top:1px solid var(--border-light); padding-top:15px; margin-top:10px;">
                        <label>Cantidad de Grupos</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="number" id="totalGroupsInput" min="1" max="50" placeholder="Ej: 5" style="width:80px; text-align:center;">
                            <button class="btn primary" onclick="updateTotalGroups()" style="flex:1;">Actualizar Cantidad</button>
                        </div>

                        <label>Gestionar Claves de Grupos</label>
                        <div style="display:flex; gap:10px;">
                            <select id="groupSelector" onchange="loadGroupPassword()" style="flex:1;">
                                </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="groupPwdInput" placeholder="Clave..." style="flex:1; text-align:center; font-weight:bold;">
                            <button class="btn success" onclick="saveSingleGroupPassword()">Guardar Clave</button>
                        </div>
                    </div>
                </div>
            </details>
            <div class="settings-group admin-only">
                <div style="background:#fffbeb; padding:15px;">
                    <div style="text-align:center;">
                        <p style="margin:0 0 10px 0; font-size:0.9rem; color:#92400e; font-weight:600;">ü§ù Apoyo Voluntario</p>
                        <p style="font-size:0.8rem; color:#b45309; margin-bottom:15px;">Esta app es gratuita. Si deseas apoyar los <b>gastos t√©cnicos y de desarrollo</b> para mantenerla funcionando:</p>
                        <button onclick="window.open('TU_LINK_MERCADOPAGO', '_blank')" style="background:#f59e0b; color:white; border:none; padding:12px 20px; border-radius:50px; font-weight:700; cursor:pointer; box-shadow:0 4px 6px rgba(245, 158, 11, 0.3); display:flex; align-items:center; gap:10px; width:100%; justify-content:center; transition:0.2s;">
                            <span style="font-size:1.2rem;">‚òï</span> Inv√≠tame un Caf√©
                        </button>
                    </div>
                </div>
                <div style="padding:10px; text-align:center; font-size:0.7rem; color:var(--text-muted); background:#f9fafb;">v1.0.52 ‚Ä¢ Desarrollo Independiente</div>
            </div>
        </div>
    </div>
</div>

<div id="modalPwd" style="display:none;">
    <div class="card" style="width:300px; margin-bottom:0; text-align: center;">
        <h3>Cambiar Clave Admin</h3>
        <input type="password" id="pNew" placeholder="Nueva clave" style="margin-bottom:15px; text-align: center;">
        <button class="btn primary" onclick="updatePassword()" style="width:100%; margin-bottom:10px;">Guardar</button>
        <button class="btn ghost" onclick="$('#modalPwd').style.display='none'" style="width:100%;">Cancelar</button>
    </div>
</div>

<div id="app-content">
    <header class="top">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="background:var(--primary); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:1.1rem;">CP</div>
            <div>
                <h1 style="font-size: 1.1rem; font-weight: 800; margin:0;">Congregaci√≥n Pro</h1>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span id="roleBadge">...</span>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button class="btn ghost" onclick="openSettings()">‚öôÔ∏è Ajustes</button>
            <div style="display:flex; gap:5px; align-items:center; background:#fff; padding:4px; border-radius:8px; border:1px solid var(--border-light);">
                <input type="number" id="headerYear" style="width:70px; border:none; box-shadow:none; padding:5px; font-weight:bold; text-align:center;">
                <select id="headerMonth" style="width:110px; border:none; box-shadow:none; padding:5px; font-weight:bold;"></select>
            </div>
            <button class="btn danger" onclick="location.reload()" style="padding:8px 12px;">üîí</button>
        </div>
    </header>

    <div class="tabs-container">
        <div class="tabs">
            <button data-tab="personas" class="active admin-only">1. Gesti√≥n</button>
            <button data-tab="lista_global" class="admin-only">2. Lista General</button>
            <button data-tab="actividad" id="tabActividad">3. Informes</button>
            <button data-tab="asistencia" class="admin-only">4. Asistencia</button>
            <button data-tab="precursores" class="admin-only">5. Precursores</button>
            <button data-tab="tarjeta" class="admin-only">6. Tarjeta Publicador</button>
            <button data-tab="s88" class="admin-only">7. Registro Asistencia</button>
            <button data-tab="resumen" class="admin-only">8. Resumen</button>
            <button data-tab="sacados" class="admin-only" style="color:var(--danger)">9. Sacados</button>
            <button data-tab="inactivos" class="admin-only" style="color:var(--warning)">10. Inactivos</button>
        </div>
    </div>

    <div class="container">
        <section id="personas" class="tab active admin-only">
            <div class="card">
                <h3>üë• Gesti√≥n de Miembros</h3>
                <div class="admin-tools-grid">
                    <input type="hidden" id="pId">
                    <div><label>Nombre Completo</label><input type="text" id="pNombre" placeholder="Ej: Juan P√©rez"></div>
                    <div><label>Grupo Predicaci√≥n</label><select id="pGrupo" class="dynamic-group-select"></select></div>
                    <div><label>Sexo</label><select id="pSexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                    <div><label>Esperanza</label><select id="pEsp"><option value="Otras ovejas">Otras ovejas</option><option value="Ungido">Ungido</option></select></div>
                </div>
                <div class="admin-tools-grid">
                    <div><label>Fecha Nacimiento</label><input type="date" id="pNac"></div>
                    <div><label>Fecha Bautismo</label><input type="date" id="pBau"></div>
                    <div><label>Fecha Expulsi√≥n (Si aplica)</label><input type="date" id="pFSac"></div>
                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:8px;">
                        <button class="btn primary" id="btnSaveP">üíæ Guardar Miembro</button>
                        <div style="display:flex; gap:8px; width:100%;">
                            <button class="btn danger" id="btnDeleteP" style="display:none; flex:1;">üóëÔ∏è Eliminar</button>
                            <button class="btn ghost" id="btnCancelEdit" onclick="resetPForm()" style="display:none; flex:1;">Cancelar</button>
                        </div>
                    </div>
                </div>
                <div class="admin-tools-grid" style="background:var(--bg-body);">
                    <div style="grid-column:1/-1; display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                        <span style="font-weight:700; color:var(--text-muted); font-size:0.75rem; text-transform:uppercase;">Privilegios:</span>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;"><input type="checkbox" id="pAnc"> Anciano</label>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;"><input type="checkbox" id="pSM"> Siervo Min.</label>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;"><input type="checkbox" id="pPR"> Prec. Regular</label>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;"><input type="checkbox" id="pPE"> Prec. Especial</label>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;"><input type="checkbox" id="pMis"> Misionero</label>
                    </div>
                </div>
                <div class="admin-tools-grid" style="border-top:2px dashed var(--border-light); margin-top:20px;">
                    <div style="grid-column: span 2;">
                        <label>Buscar Miembro para Editar</label>
                        <div style="display:flex; gap:10px;">
                            <input type="search" id="qPersona" list="pList" placeholder="Escribe para buscar..." style="flex:1;">
                            <button class="btn primary" id="btnQEdit">‚úèÔ∏è Editar</button>
                        </div>
                    </div>
                </div>
                <datalist id="pList"></datalist>
            </div>
        </section>

        <section id="lista_global" class="tab admin-only">
            <div class="card">
                <h3><span>üìñ Lista General</span> <span id="cGen" class="count-badge">0</span></h3>
                <div class="table-container"><table class="table" id="tblMiembros"><thead><tr><th>Nombre</th><th>Grupo</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
            </div>
        </section>

        <section id="actividad" class="tab">
            <div class="card">
                <h3><span>üìù Registro de Informes</span> <span id="cAct" class="count-badge">0</span></h3>
                <div class="admin-tools-grid">
                    <div><label>Mes del Informe</label><select id="actMonthSelect"></select></div>
                    <div><label>A√±o</label><input type="number" id="actYearInput"></div>
                    <div><label>Grupo</label><select id="selGInforme" class="dynamic-group-select"></select></div>
                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:5px;"><button class="btn success" id="btnSaveReports">üíæ Guardar Cambios</button></div>
                </div>
                <div class="table-container"><table class="table" id="tblActividad"><thead><tr><th>Nombre</th><th>Part.</th><th>Horas</th><th>Cursos</th><th>P. Aux</th><th>Notas</th></tr></thead><tbody></tbody></table></div>
            </div>
        </section>

        <section id="asistencia" class="tab admin-only">
            <div class="card">
                <h3>üìä Registro de Asistencia</h3>
                <div class="admin-tools-grid"><div><label>Mes</label><select id="asistMonthSelect"></select></div><div><label>A√±o</label><input type="number" id="asistYearInput"></div></div>
                <div class="asist-grid-layout"><div class="asist-col"><h4>Reuni√≥n Vida y Ministerio</h4><div id="contES"></div></div><div class="asist-col"><h4>Reuni√≥n P√∫blica</h4><div id="contFS"></div></div></div>
                <div style="margin-top:20px; text-align:right;"><button class="btn success" id="btnSaveAsist" style="width:200px;">üíæ Guardar Asistencia</button></div>
            </div>
        </section>

        <section id="precursores" class="tab admin-only">
            <div class="card"><h3><span>üèÖ Precursores Regulares</span> <span id="cPre" class="count-badge">0</span></h3><div class="table-container"><table class="table" id="tblPrecursores"><tbody></tbody></table></div></div>
            <div class="card" style="margin-top:20px;"><h3>üèÉ Precursores Auxiliares (Mes Actual)</h3><div class="table-container"><table class="table" id="tblAuxiliares"><tbody></tbody></table></div></div>
        </section>

        <section id="tarjeta" class="tab admin-only">
            <div class="card">
                <h3>üìá Tarjeta de Publicador</h3>
                <div class="admin-tools-grid">
                    <div><label>Modo</label><select id="s21Mode" onchange="toggleS21Inputs()"><option value="individual">Individual</option><option value="group">Por Grupo</option><option value="pr">Solo Precursores</option><option value="all">Todos</option></select></div>
                    <div id="s21InputIndiv"><label>Buscar Persona</label><input id="s21Search" list="pList" placeholder="Escribe nombre..."></div>
                    <div id="s21InputGroup" style="display:none;"><label>Grupo</label><select id="s21GroupSel" class="dynamic-group-select"></select></div>
                    <div><label>A√±o Servicio</label><input type="number" id="s21Year"></div>
                    <div style="display:flex; align-items:flex-end; gap:10px;"><button class="btn primary" onclick="previewS21()">üëÅÔ∏è Ver</button><button class="btn success" onclick="downloadPDFS21()">üì• PDF</button></div>
                </div>
                <div id="preview-viewport"></div>
            </div>
        </section>

        <section id="s88" class="tab admin-only">
            <div class="card">
                <h3>üìà Registro de Asistencia</h3>
                <div class="admin-tools-grid">
                    <div><label>A√±o Servicio</label><input type="number" id="s88Year"></div>
                    <div style="display:flex; align-items:flex-end; gap:10px;"><button class="btn primary" onclick="renderS88Preview()">üëÅÔ∏è Ver</button><button class="btn success" onclick="generatePDF('s88')">üì• PDF</button></div>
                </div>
                <div id="s88-preview-viewport"></div>
            </div>
        </section>

        <section id="resumen" class="tab admin-only">
            <div class="card">
                <h3>üìä Resumen Mensual</h3>
                <div class="admin-tools-grid">
                    <div><label>Mes</label><select id="resMonth"></select></div><div><label>A√±o</label><input type="number" id="resYear"></div>
                    <div style="display:flex; align-items:flex-end;"><button class="btn primary" id="btnSearchRes" style="width:100%;">üîç Analizar Datos</button></div>
                </div>
                <div id="resumenContent" style="margin-top:20px;"></div>
            </div>
        </section>

        <section id="sacados" class="tab admin-only">
            <div class="card"><h3><span style="color:var(--danger)">üö´ Lista de Sacados</span> <span id="cSac" class="count-badge">0</span></h3><div class="table-container"><table class="table" id="tblSacados"><thead><tr><th>Nombre</th><th>Fecha Bautismo</th><th>Fecha Salida</th></tr></thead><tbody></tbody></table></div></div>
        </section>

        <section id="inactivos" class="tab admin-only">
            <div class="card"><h3><span style="color:var(--danger)">üí§ Inactivos</span> <span id="cIna" class="count-badge">0</span></h3><div class="table-container"><table class="table" id="tblInactivos"><thead><tr><th>Nombre</th><th>Grupo</th><th>√öltima Actividad</th><th>Tiempo Inactivo</th></tr></thead><tbody></tbody></table></div></div>
            <div class="card" style="margin-top:20px;"><h3><span style="color:var(--warning)">‚ö†Ô∏è Irregulares</span></h3><div class="table-container"><table class="table" id="tblIrregulares"><thead><tr><th>Nombre</th><th>Grupo</th><th>Meses Fallados</th></tr></thead><tbody></tbody></table></div></div>
        </section>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let app, db;
    const DB_KEY = 'cong_pro_v108_master';
    const CRED_KEY = 'cong_pro_firebase_creds';
    const $ = s => document.querySelector(s);
    const ymKey = (y,m) => `${y}-${String(m).padStart(2,'0')}`;
    const MESES_NOM = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const CICLO_S88 = [9,10,11,12,1,2,3,4,5,6,7,8];
    
    let state = { 
        personas: [], activity: {}, attendance: {}, 
        config: { pwd: '12345', totalGroups: 5, groups: { '1': 'grupo1', '2': 'grupo2', '3': 'grupo3', '4': 'grupo4', '5': 'grupo5' } } 
    }; 
    
    let CURRENT_ROLE = 'ADMIN'; 
    let curY = new Date().getFullYear(), curM = new Date().getMonth()+1;
    let actY = curY, actM = curM, asistY = curY, asistM = curM;

    window.openSettings = function() {
        const modal = $('#modalSettings'); modal.style.display = 'flex';
        const stored = localStorage.getItem(CRED_KEY);
        if(stored) {
            const c = JSON.parse(stored);
            $('#fbApiKey').value = c.apiKey; $('#fbProjectId').value = c.projectId;
            updateCloudUI(true, c.projectId);
        } else { updateCloudUI(false); }
        loadGroupPassword();
        if($('#totalGroupsInput')) $('#totalGroupsInput').value = state.config.totalGroups || 5;
    };

    function updateCloudUI(connected, pid) {
        const card = $('#cloudStatusCard'); const title = $('#cloudTitle'); const desc = $('#cloudDesc'); const icon = $('#cloudIcon');
        if(connected) { card.className = 'status-card'; icon.innerText = 'üü¢'; title.innerText = 'Conectado a Nube'; desc.innerText = 'ID: ' + pid; } 
        else { card.className = 'status-card offline'; icon.innerText = '‚ö°'; title.innerText = 'Modo Local'; desc.innerText = 'Datos solo en este dispositivo.'; }
    }

    window.closeSettings = function() { $('#modalSettings').style.display = 'none'; };

    // --- L√ìGICA DE GRUPOS DIN√ÅMICOS ---
    window.renderGroupOptions = function() {
        const total = state.config.totalGroups || 5;
        const selects = document.querySelectorAll('.dynamic-group-select'); // Clases: pGrupo, selGInforme, s21GroupSel
        const pwdSelect = $('#groupSelector');

        // Generar HTML de opciones
        let opts = '';
        for(let i=1; i<=total; i++) { opts += `<option value="${i}">Grupo ${i}</option>`; }

        // Actualizar selects normales
        selects.forEach(sel => {
            const currentVal = sel.value; // Guardar valor seleccionado si existe
            sel.innerHTML = opts;
            if(currentVal && currentVal <= total) sel.value = currentVal;
        });

        // Actualizar select de contrase√±as
        if(pwdSelect) {
            const currentPwdVal = pwdSelect.value;
            pwdSelect.innerHTML = opts;
            if(currentPwdVal && currentPwdVal <= total) pwdSelect.value = currentPwdVal;
        }
    }

    window.updateTotalGroups = function() {
        const val = parseInt($('#totalGroupsInput').value);
        if(!val || val < 1 || val > 50) return alert("Por favor, ingresa entre 1 y 50 grupos.");
        
        state.config.totalGroups = val;
        // Asegurar que existan claves para los nuevos grupos si se a√±aden
        if(!state.config.groups) state.config.groups = {};
        for(let i=1; i<=val; i++) {
            if(!state.config.groups[i]) state.config.groups[i] = 'grupo' + i;
        }
        
        save();
        renderGroupOptions();
        alert(`‚úÖ Configuraci√≥n actualizada a ${val} grupos.`);
    }
    // ----------------------------------

    window.loadGroupPassword = function() {
        if(!state.config.groups) state.config.groups = {};
        const gID = $('#groupSelector').value;
        const currentPwd = state.config.groups[gID] || ('grupo' + gID); 
        $('#groupPwdInput').value = currentPwd;
    }

    window.saveSingleGroupPassword = function() {
        if(!state.config.groups) state.config.groups = {};
        const gID = $('#groupSelector').value;
        const newPwd = $('#groupPwdInput').value.trim();
        if(!newPwd) return alert("La clave no puede estar vac√≠a");
        state.config.groups[gID] = newPwd;
        save();
        showToast(`Clave del Grupo ${gID} guardada`);
    }

    window.init = function() {
        $('#mEnter').onclick = attemptLogin;
        $('#mPwd').onkeydown = (e) => { if(e.key==='Enter') attemptLogin(); };
        const mSels = [$('#headerMonth'), $('#actMonthSelect'), $('#resMonth'), $('#asistMonthSelect')];
        mSels.forEach(sel => { if(sel){ sel.innerHTML=''; MESES_NOM.forEach((m,i)=>{const o=document.createElement('option'); o.value=i+1; o.text=m; if(i+1===curM)o.selected=true; sel.appendChild(o);}); } });
        if($('#headerYear')) $('#headerYear').value = curY;
        if($('#actYearInput')) $('#actYearInput').value = curY;
        if($('#asistYearInput')) $('#asistYearInput').value = curY;
        if($('#resYear')) $('#resYear').value = curY;
        if($('#s21Year')) $('#s21Year').value = (curM>=9)?curY:curY-1;
        if($('#s88Year')) $('#s88Year').value = (curM>=9)?curY:curY-1;
        
        if($('#headerMonth')) $('#headerMonth').onchange = (e) => { curM=parseInt(e.target.value); renderAll(); };
        if($('#headerYear')) $('#headerYear').onchange = (e) => { curY=parseInt(e.target.value); renderAll(); };
        if($('#selGInforme')) $('#selGInforme').onchange = renderActividad;
        if($('#actMonthSelect')) $('#actMonthSelect').onchange = (e) => { actM=parseInt(e.target.value); renderActividad(); };
        if($('#actYearInput')) $('#actYearInput').onchange = (e) => { actY=parseInt(e.target.value); renderActividad(); };
        if($('#asistMonthSelect')) $('#asistMonthSelect').onchange = (e) => { asistM=parseInt(e.target.value); renderAsistInputs(); };
        if($('#asistYearInput')) $('#asistYearInput').onchange = (e) => { asistY=parseInt(e.target.value); renderAsistInputs(); };
        if($('#btnSearchRes')) $('#btnSearchRes').onclick = () => renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
        
        if($('#btnSaveP')) $('#btnSaveP').onclick = savePersona;
        if($('#btnDeleteP')) $('#btnDeleteP').onclick = deletePersona;
        if($('#btnQEdit')) $('#btnQEdit').onclick = () => { const n=$('#qPersona').value; const p=state.personas.find(x=>x.nombre===n); if(p) { editP(p.id); document.querySelector('[data-tab="personas"]').click(); } };
        if($('#btnSaveReports')) $('#btnSaveReports').onclick = () => { save(); showToast("Guardado y Sincronizado ‚òÅÔ∏è"); };
        if($('#btnSaveAsist')) $('#btnSaveAsist').onclick = () => { save(); showToast("Asistencia Guardada ‚òÅÔ∏è"); renderS88Preview(); };
        
        document.querySelectorAll('.tabs button').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.tabs button, .tab').forEach(el=>el.classList.remove('active'));
                b.classList.add('active');
                if($(`#${b.dataset.tab}`)) $(`#${b.dataset.tab}`).classList.add('active');
                if(b.dataset.tab === 'actividad') renderActividad();
                if(b.dataset.tab === 'asistencia') renderAsistInputs();
                if(b.dataset.tab === 'precursores') { renderPrecursores(); renderAuxiliares(); }
                if(b.dataset.tab === 'resumen') renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
                if(b.dataset.tab === 'sacados') renderSacados();
                if(b.dataset.tab === 'inactivos') renderEstadoEspiritual();
                if(b.dataset.tab === 'tarjeta') updateDatalist();
                if(b.dataset.tab === 'lista_global') renderMiembros();
            };
        });

        const storedCreds = localStorage.getItem(CRED_KEY);
        if(storedCreds) {
            const creds = JSON.parse(storedCreds);
            connectFirebase(creds.apiKey, creds.projectId);
        }
    }

    window.saveCloudCredentials = function() {
        const apiKey = $('#fbApiKey').value.trim();
        const projectId = $('#fbProjectId').value.trim();
        if(!apiKey || !projectId) return alert("Por favor ingresa ambos datos");
        localStorage.setItem(CRED_KEY, JSON.stringify({ apiKey, projectId }));
        connectFirebase(apiKey, projectId);
    }

    function connectFirebase(apiKey, projectId) {
        const statusSpan = $('#statusIndicator');
        statusSpan.innerHTML = 'üü° Conectando...';
        try {
            const firebaseConfig = { apiKey: apiKey, authDomain: `${projectId}.firebaseapp.com`, projectId: projectId, storageBucket: `${projectId}.firebasestorage.app` };
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            startRealtimeSync();
            statusSpan.className = 'status-sync'; statusSpan.innerHTML = 'üü¢ Conectado';
            updateCloudUI(true, projectId);
            if($('#modalSettings').style.display === 'flex') showToast("Conexi√≥n Exitosa");
        } catch(e) {
            console.error(e); statusSpan.className = 'status-offline'; statusSpan.innerHTML = 'üî¥ Error API';
            alert("Error conectando a Firebase. Revisa la consola o las claves.");
            updateCloudUI(false);
        }
    }

    function startRealtimeSync() {
        const statusSpan = $('#statusIndicator');
        if(!db) return;
        onSnapshot(doc(db, "congregacion", "datos_generales"), (doc) => {
            if(doc.exists()) {
                const cloudData = doc.data(); state = cloudData;
                // Init Defaults
                if(!state.personas) state.personas = [];
                if(!state.activity) state.activity = {};
                if(!state.attendance) state.attendance = {};
                if(!state.config) state.config = { pwd: '12345', totalGroups: 5, groups: {} };
                
                localStorage.setItem(DB_KEY, JSON.stringify(state));
                renderAll();
                statusSpan.className = 'status-sync'; statusSpan.innerHTML = 'üü¢ Conectado';
            } else { save(); }
        }, (error) => { console.error("Error sync:", error); statusSpan.className = 'status-offline'; statusSpan.innerHTML = 'üî¥ Sin conexi√≥n'; updateCloudUI(false); });
    }

    window.save = async function() {
        localStorage.setItem(DB_KEY, JSON.stringify(state));
        updateDatalist();
        if(db) {
            const statusSpan = $('#statusIndicator'); statusSpan.innerHTML = 'üîÑ Guardando...';
            try { await setDoc(doc(db, "congregacion", "datos_generales"), state); statusSpan.innerHTML = 'üü¢ Conectado'; } catch(e) { statusSpan.className = 'status-offline'; statusSpan.innerHTML = '‚ö†Ô∏è Error Guardado'; }
        }
    }

    window.attemptLogin = function() {
        const pwd = $('#mPwd').value;
        const adminPwd = (state.config && state.config.pwd) ? state.config.pwd : '12345';
        if (pwd === adminPwd) { CURRENT_ROLE = 'ADMIN'; enterApp(); return; } 
        let foundGroup = null;
        const groups = state.config.groups || {};
        for (const [grpNum, grpPwd] of Object.entries(groups)) { if (grpPwd === pwd) { foundGroup = grpNum; break; } }
        if (foundGroup) { CURRENT_ROLE = 'G' + foundGroup; enterApp(); } else { alert("‚ùå Clave incorrecta"); }
    }

    function enterApp() {
        $('#modalAuth').style.display = 'none';
        $('#app-content').style.display = 'block';
        document.body.className = (CURRENT_ROLE === 'ADMIN') ? 'role-admin' : 'role-restricted';
        const badge = $('#roleBadge');
        if(CURRENT_ROLE === 'ADMIN') {
            badge.innerText = 'Administrador'; badge.style.background = '#e0e7ff'; badge.style.color = '#4338ca';
        } else {
            const g = CURRENT_ROLE.replace('G','');
            badge.innerText = `Encargado Grupo ${g}`; badge.style.background = '#d1fae5'; badge.style.color = '#065f46';
            $('#selGInforme').value = g; $('#selGInforme').disabled = true;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            $('#actividad').classList.add('active'); $('#tabActividad').classList.add('active');
        }
        renderAll();
    }

    try { const saved = localStorage.getItem(DB_KEY); if(saved) state = JSON.parse(saved); } catch(e) {}
    if(!state.personas) state.personas = [];
    if(!state.config) state.config = { pwd: '12345', totalGroups: 5, groups: {} };

    function renderAll() {
        renderGroupOptions(); // RENDERIZAR GRUPOS DIN√ÅMICAMENTE
        if(CURRENT_ROLE === 'ADMIN') { renderMiembros(); renderSacados(); renderEstadoEspiritual(); renderPrecursores(); renderAuxiliares(); renderAsistInputs(); }
        renderActividad();
        updateDatalist();
    }

    window.renderActividad = function() {
        const g = $('#selGInforme').value;
        const tb = $('#tblActividad tbody');
        const k = ymKey(actY, actM);
        tb.innerHTML = '';
        const list = state.personas.filter(p => p.grupo == g && !p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));
        const cEl = $('#cAct'); if(cEl) cEl.innerText = `(${list.length})`;
        if(list.length === 0) { tb.innerHTML = `<tr><td colspan="6" style="padding:30px; text-align:center; color:var(--text-muted);">No hay miembros en el Grupo ${g}.</td></tr>`; return; }
        list.forEach(p => {
            const r = state.activity[k]?.[p.id] || {part:false, horas:0, est:0, pa:false, nota:''};
            tb.innerHTML += `<tr><td style="font-weight:600;">${p.nombre}</td><td style="text-align:center;"><input type="checkbox" ${r.part?'checked':''} onchange="updAct('${p.id}','part',this.checked)"></td><td><input type="number" value="${r.horas}" onchange="updAct('${p.id}','horas',this.value)" style="width:60px; text-align:center;"></td><td><input type="number" value="${r.est}" onchange="updAct('${p.id}','est',this.value)" style="width:60px; text-align:center;"></td><td style="text-align:center;"><input type="checkbox" ${r.pa?'checked':''} onchange="updAct('${p.id}','pa',this.checked)"></td><td><input type="text" value="${r.nota||''}" onchange="updAct('${p.id}','nota',this.value)" placeholder="..."></td></tr>`;
        });
    }

    window.updAct = (pid, f, v) => { 
        const k = ymKey(actY, actM); 
        if(!state.activity[k]) state.activity[k] = {}; 
        if(!state.activity[k][pid]) state.activity[k][pid] = {part:false, horas:0, est:0, pa:false}; 
        state.activity[k][pid][f] = (f==='pa'||f==='part'||f==='nota') ? v : parseFloat(v||0); 
        save(); 
    }

    window.savePersona = function() { 
        const id=$('#pId').value, n=$('#pNombre').value.trim(); 
        if(!n) return alert("Nombre obligatorio"); 
        const data={ id:id||'p'+Date.now(), nombre:n, grupo:$('#pGrupo').value, sexo:$('#pSexo').value, esp:$('#pEsp').value, nac:$('#pNac').value, bau:$('#pBau').value, fsac:$('#pFSac').value, pr:$('#pPR').checked, anciano:$('#pAnc').checked, sm:$('#pSM').checked, pe:$('#pPE').checked, mis:$('#pMis').checked, sacado:!!$('#pFSac').value }; 
        if(id) state.personas[state.personas.findIndex(x=>x.id===id)]=data; else state.personas.push(data); 
        save(); renderMiembros(); resetPForm(); showToast("Guardado");
    }
    
    window.deletePersona = function() { const id=$('#pId').value; if(!id)return; if(confirm("¬øELIMINAR miembro?")) { state.personas=state.personas.filter(p=>p.id!==id); save(); renderMiembros(); resetPForm(); showToast("Eliminado"); } }
    
    window.resetPForm = function() { $('#pId').value=''; $('#pNombre').value=''; ['pNac','pBau','pFSac','pSexo','pEsp'].forEach(id=>$('#'+id).value=''); ['pAnc','pSM','pPE','pMis','pPR'].forEach(id=>$('#'+id).checked=false); $('#btnCancelEdit').style.display='none'; $('#btnDeleteP').style.display='none'; $('#btnSaveP').textContent = 'üíæ Guardar Miembro'; $('#btnSaveP').className = 'btn primary'; }
    
    window.renderMiembros = function() { 
        const tb=$('#tblMiembros tbody'); if(!tb)return; tb.innerHTML=''; 
        const list = state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));
        const cEl = $('#cGen'); if(cEl) cEl.innerText = `(${list.length})`;
        list.forEach(p=>{ 
            const tr=document.createElement('tr'); 
            tr.innerHTML=`<td><div style="font-weight:700;">${p.nombre}</div><div style="font-size:0.75rem; color:var(--text-muted);">${getPrivilegesString(p)}</div></td><td><span style="background:#f3f4f6; padding:2px 8px; border-radius:4px; font-weight:600;">G${p.grupo}</span></td><td><button class="btn ghost" style="padding:4px 8px; font-size:0.8rem;" onclick="editP('${p.id}')">‚úèÔ∏è Editar</button></td>`; 
            tb.appendChild(tr); 
        }); 
    }
    
    window.getPrivilegesString = function(p) { return [p.anciano?'Anciano':'', p.sm?'SM':'', p.pr?'PR':'', p.pe?'PE':''].filter(Boolean).join(', '); }
    window.editP = (id) => { const p=state.personas.find(x=>x.id===id); if(!p)return; $('#pId').value=p.id; $('#pNombre').value=p.nombre; $('#pSexo').value=p.sexo; $('#pEsp').value=p.esp; $('#pNac').value=p.nac||''; $('#pBau').value=p.bau||''; $('#pFSac').value=p.fsac||''; $('#pPR').checked=!!p.pr; $('#pAnc').checked=!!p.anciano; $('#pSM').checked=!!p.sm; $('#pPE').checked=!!p.pe; $('#pMis').checked=!!p.mis; $('#btnCancelEdit').style.display='inline-flex'; $('#btnDeleteP').style.display='inline-flex'; $('#btnSaveP').textContent='üíæ Actualizar'; $('#btnSaveP').className='btn success'; window.scrollTo({top:0, behavior:'smooth'}); }
    
    window.updateDatalist = function() { const l=$('#pList'); if(l){ l.innerHTML = ''; state.personas.forEach(p => l.innerHTML += `<option value="${p.nombre}">`); } }
    window.showToast = function(m) { const t=$('#toast'); t.innerHTML = `<span>${m}</span>`; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
    window.exportBackup = function() { const blob=new Blob([JSON.stringify(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`CongPro_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    window.updatePassword = function() { if(!state.config) state.config={}; const p=$('#pNew').value; if(p) { state.config.pwd=p; save(); $('#modalPwd').style.display='none'; showToast("Clave actualizada"); } }
    
    window.renderSacados=function(){
        const tb=$('#tblSacados tbody');if(!tb)return;tb.innerHTML='';
        const list = state.personas.filter(p=>p.sacado);
        const cEl = $('#cSac'); if(cEl) cEl.innerText = `(${list.length})`;
        list.forEach(p=>{tb.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.bau||'-'}</td><td style="color:var(--danger)">${p.fsac||'-'}</td></tr>`;});
    }
    window.renderPrecursores=function(){
        const tb=$('#tblPrecursores tbody');if(!tb)return;tb.innerHTML='';
        const list = state.personas.filter(p=>p.pr&&!p.sacado);
        const cEl = $('#cPre'); if(cEl) cEl.innerText = `(${list.length})`;
        list.forEach(p=>{tb.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${p.bau||'-'}</td><td><span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:4px; font-weight:bold;">Activo</span></td></tr>`;});
    }
    window.renderAuxiliares=function(){const tb=$('#tblAuxiliares tbody'),k=ymKey(curY,curM);if(!tb)return;tb.innerHTML='';state.personas.filter(p=>!p.sacado&&state.activity[k]?.[p.id]?.pa).forEach(p=>{tb.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${state.activity[k][p.id].horas} horas</td></tr>`;});}
    
    window.renderAsistInputs=function(){const k=ymKey(asistY,asistM);if(!state.attendance[k])state.attendance[k]={es:[0,0,0,0,0,0],fs:[0,0,0,0,0,0]};const cES=$('#contES'),cFS=$('#contFS');cES.innerHTML='';cFS.innerHTML='';for(let i=0;i<5;i++){cES.innerHTML+=`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="margin:0;">Semana ${i+1}</label><input type="number" value="${state.attendance[k].es[i]||0}" oninput="updAsist('es',${i},this.value)" style="width:80px; text-align:center;"></div>`;cFS.innerHTML+=`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="margin:0;">Semana ${i+1}</label><input type="number" value="${state.attendance[k].fs[i]||0}" oninput="updAsist('fs',${i},this.value)" style="width:80px; text-align:center;"></div>`;}}
    window.updAsist=(t,i,v)=>{const k=ymKey(asistY,asistM);state.attendance[k][t][i]=parseInt(v||0);save();}

    window.renderEstadoEspiritual = function() { 
        const tbIn=$('#tblInactivos tbody'), tbIrr=$('#tblIrregulares tbody'); if(!tbIn)return; tbIn.innerHTML=''; tbIrr.innerHTML=''; 
        const syStart = (curM>=9)?curY:curY-1; 
        let countIna = 0;
        state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p=>{ 
            let zeros=0, last='-'; 
            for(let i=0;i<36;i++){ let ty=curY, tm=curM-i; while(tm<=0){tm+=12;ty--;} const act=state.activity[ymKey(ty,tm)]?.[p.id]; if(act&&(act.horas>0||act.part)){ last=`${MESES_NOM[tm-1]} ${ty}`; break; } else if(i<6) zeros++; } 
            if(zeros>=6){ 
                countIna++;
                tbIn.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${last}</td><td><span style="background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:4px; font-weight:bold;">+${zeros} meses</span></td></tr>`; 
            } 
            else { let fail=[]; for(let i=1;i<=12;i++){ let ty=curY, tm=curM-i; while(tm<=0){tm+=12;ty--;} if(ty<syStart || (ty===syStart && tm<9)) break; const act=state.activity[ymKey(ty,tm)]?.[p.id]; if(!act||(!act.horas && !act.part)) fail.push(MESES_NOM[tm-1].substr(0,3)); } if(fail.length>0){ tbIrr.innerHTML+=`<tr><td>${p.nombre}</td><td>G${p.grupo}</td><td><span style="color:var(--warning); font-weight:600;">${fail.join(', ')}</span></td></tr>`; } } 
        });
        const cEl = $('#cIna'); if(cEl) cEl.innerText = `(${countIna})`;
    }

    window.toggleS21Inputs = function() { const m=$('#s21Mode').value; $('#s21InputIndiv').style.display=(m==='individual')?'block':'none'; $('#s21InputGroup').style.display=(m==='group')?'block':'none'; $('#preview-viewport').innerHTML=''; }
    window.getS21HTML = function(p,sy) { let rows='',tH=0; CICLO_S88.forEach(m=>{ const y=(m>=9)?sy:sy+1, r=state.activity[ymKey(y,m)]?.[p.id]||{horas:0,est:0,pa:false,part:false}; tH+=(r.horas||0); rows+=`<tr><td>${MESES_NOM[m-1]}</td><td>${(r.horas||r.part)?'[X]':''}</td><td>${r.est||''}</td><td>${r.pa?'[X]':''}</td><td>${r.horas||''}</td><td></td></tr>`; }); const privs = [p.anciano?'Anciano':'', p.sm?'SM':'', p.pr?'PR':'', p.pe?'PE':''].filter(Boolean).join(', '); return `<div class="print-canvas"><div style="text-align:center; font-weight:800; font-size:12pt; margin-bottom:10px;">REGISTRO DE PUBLICADOR</div><div class="s21-header-box"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Nombre:</b> ${p.nombre}</span><span><b>Grupo:</b> ${p.grupo}</span></div><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>F. Nacimiento:</b> ${p.nac||'-'}</span><span><b>F. Bautismo:</b> ${p.bau||'-'}</span></div><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Sexo:</b> ${p.sexo}</span><span><b>Esperanza:</b> ${p.esp}</span></div><div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><b>Privilegios:</b> ${privs||'Publicador'}</div></div><table class="official-table"><thead><tr><th style="width:20%">A√±o ${sy}-${sy+1}</th><th>Partic.</th><th>Est</th><th>P. Aux</th><th>Horas</th><th>Notas</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td colspan="4" style="text-align:right; font-weight:bold;">Total Horas:</td><td>${tH}</td><td></td></tr></tfoot></table></div>`; }
    window.previewS21 = function() { const m=$('#s21Mode').value; let l=[]; if(m==='individual'){const n=$('#s21Search').value; const p=state.personas.find(x=>x.nombre===n); if(p)l=[p];} else if(m==='group'){l=state.personas.filter(p=>p.grupo==$('#s21GroupSel').value && !p.sacado);} else if(m==='pr'){l=state.personas.filter(p=>p.pr&&!p.sacado);} else {l=state.personas.filter(p=>!p.sacado);} $('#preview-viewport').innerHTML=l.map(p=>getS21HTML(p,parseInt($('#s21Year').value))).join(''); }
    window.downloadPDFS21 = function() { const el=$('#preview-viewport'); if(!el.innerHTML) return alert("Ver primero"); html2pdf().set({margin:0,filename:'S21.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:1.5},jsPDF:{unit:'mm',format:'a4'}}).from(el).save(); }
    window.renderS88Preview = function() { const sy=parseInt($('#s88Year').value); const build=(t)=>{let rows='',tA=0,tR=0; CICLO_S88.forEach(m=>{const y=(m>=9)?sy:sy+1, d=state.attendance[ymKey(y,m)]?.[t]||[0,0,0,0,0,0], re=d.filter(v=>v>0).length, as=d.reduce((a,b)=>a+b,0), pr=re>0?Math.round(as/re):''; tA+=as; tR+=re; rows+=`<tr><td>${MESES_NOM[m-1]}</td><td>${re||''}</td><td>${as||''}</td><td><b>${pr}</b></td></tr>`;}); return {h:rows,avg:tR>0?Math.round(tA/tR):''};}; const es=build('es'), fs=build('fs'); $('#s88-preview-viewport').innerHTML=`<div class="print-canvas"><div style="text-align:center; font-weight:800;">REGISTRO ASISTENCIA</div><br><b>REUNI√ìN VIDA Y MINISTERIO</b><table class="official-table"><thead><tr><th>Mes</th><th>Reun</th><th>Total</th><th>Prom</th></tr></thead><tbody>${es.h}</tbody><tfoot><tr><td colspan="3" style="text-align:right">PROM. ANUAL</td><td>${es.avg}</td></tr></tfoot></table><br><b>REUNI√ìN P√öBLICA</b><table class="official-table"><thead><tr><th>Mes</th><th>Reun</th><th>Total</th><th>Prom</th></tr></thead><tbody>${fs.h}</tbody><tfoot><tr><td colspan="3" style="text-align:right">PROM. ANUAL</td><td>${fs.avg}</td></tr></tfoot></table></div>`; }
    window.generatePDF = function() { const el=$('#s88-preview-viewport .print-canvas'); if(!el)return; html2pdf().set({margin:0,filename:'S88.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:1.5},jsPDF:{unit:'mm',format:'a4'}}).from(el).save(); }
    
    // DASHBOARD RESUMEN
    window.renderResumenMensual = function(y, m) { 
        const k=ymKey(y,m), act=state.activity[k]||{}, att=state.attendance[k]||{es:[],fs:[]}; 
        let tM=0,activos=0,pubC=0,pubE=0,prC=0,prH=0,prE=0,paC=0,paH=0,paE=0; 
        const last6=[]; for(let i=0;i<6;i++){let tm=m-i,ty=y; if(tm<=0){tm+=12;ty-=1;} last6.push(ymKey(ty,tm));} 
        state.personas.forEach(p=>{ 
            if(p.sacado)return; tM++; 
            let haInf=false; for(const lk of last6){ if(state.activity[lk]?.[p.id]?.horas>0 || state.activity[lk]?.[p.id]?.part){ haInf=true; break; } } if(haInf) activos++; 
            const r=act[p.id]||{}; if(r.horas>0||r.part){ const h=parseFloat(r.horas||0), e=parseInt(r.est||0); if(p.pr){prC++;prH+=h;prE+=e;} else if(r.pa){paC++;paH+=h;paE+=e;} else{pubC++;pubE+=e;} } 
        }); 
        const avgES=att.es.filter(n=>n>0).length?Math.round(att.es.reduce((a,b)=>a+b,0)/att.es.filter(n=>n>0).length):0; 
        const avgFS=att.fs.filter(n=>n>0).length?Math.round(att.fs.reduce((a,b)=>a+b,0)/att.fs.filter(n=>n>0).length):0; 
        
        $('#resumenContent').innerHTML=`
        <div class="dash-grid">
            <div class="dash-card">
                <div class="dash-header">Totales Generales</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num num-blue">${tM}</div><div class="dash-label">Miembros</div></div>
                    <div class="dash-stat"><div class="dash-num num-green">${activos}</div><div class="dash-label">Activos</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Publicadores</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${pubC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${pubE}</div><div class="dash-label">Estudios</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Precursores Regulares</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${prC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${prH}</div><div class="dash-label">Horas</div></div>
                    <div class="dash-stat"><div class="dash-num">${prE}</div><div class="dash-label">Est</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Precursores Auxiliares</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${paC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${paH}</div><div class="dash-label">Horas</div></div>
                    <div class="dash-stat"><div class="dash-num">${paE}</div><div class="dash-label">Est</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Asistencia Promedio</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num num-purple">${avgES}</div><div class="dash-label">Vida y Min</div></div>
                    <div class="dash-stat"><div class="dash-num num-orange">${avgFS}</div><div class="dash-label">P√∫blica</div></div>
                </div>
            </div>
        </div>`; 
    }

    window.importData = (input) => { 
        const file = input.files[0]; 
        if(!file) return; 
        if(!confirm("‚ö†Ô∏è ¬øRestaurar copia de seguridad? Esto reemplazar√° los datos actuales.")) { input.value = ''; return; }
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                const data = JSON.parse(e.target.result);
                if(data.personas && Array.isArray(data.personas)) {
                    state = data; save(); alert("‚úÖ Datos restaurados correctamente. La p√°gina se recargar√°."); location.reload();
                } else { alert("‚ùå El archivo no parece ser un backup v√°lido de Congregaci√≥n Pro."); }
            } catch(err) { alert("‚ùå Error leyendo el archivo: " + err.message); } 
        }; 
        reader.readAsText(file); 
    }

    window.addEventListener("DOMContentLoaded", () => { init(); });
</script>
</body>
</html>
