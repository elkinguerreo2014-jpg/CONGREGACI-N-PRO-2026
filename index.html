window.toggleConnection = function() {
    const stored = localStorage.getItem('cong_pro_firebase_creds');
    if (!stored) return alert("‚ö†Ô∏è Primero debes configurar la conexi√≥n en Ajustes.");

    const isForcedOffline = localStorage.getItem('cong_pro_force_offline') === 'true';

    if (isForcedOffline) {
        // --- CONECTAR (De Offline a Online) ---
        
        // 1. Quitamos el candado
        localStorage.removeItem('cong_pro_force_offline'); 
        
        const c = JSON.parse(stored);
        
        // 2. Conectamos el cable
        if(window.connectFirebase) connectFirebase(c.apiKey, c.projectId);
        
        // 3. üî• ¬°ESTA ES LA CLAVE! üî•
        // Forzamos una subida inmediata de lo que hiciste mientras estabas Offline
        // para que la nube no te sobrescriba con datos viejos.
        if(window.save) window.save(); 

        // 4. Feedback visual verde inmediato
        updateCloudUI(true, c.projectId); 
        showToast("üü¢ Conectando y subiendo cambios...");

    } else {
        // --- DESCONECTAR (De Online a Offline) ---
        if (confirm("¬øDesconectar de la Nube y trabajar Offline?")) {
            localStorage.setItem('cong_pro_force_offline', 'true'); 
            
            if (window.unsubscribeSync) {
                window.unsubscribeSync(); 
                window.unsubscribeSync = null;
            }
            
            updateCloudUI(false); 
            showToast("‚ö™ Modo Offline");
        }
    }
};
