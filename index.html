<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Congregaci√≥n Pro - Master v108</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg: #f8fafc; --surface: #ffffff; --card: #ffffff;
            --fg: #0f172a; --muted: #64748b; --border: #e2e8f0; --panel: #f1f5f9;
            --accent: #2563eb; --accent-hover: #1d4ed8; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --radius-md: 12px; --radius-lg: 20px; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        [data-theme="blue"] {
            --bg: #020617; --surface: #0f172a; --card: #1e293b; --panel: #334155; --fg: #f1f5f9; --muted: #94a3b8; --border: #334155; --accent: #38bdf8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); line-height: 1.5; font-size: 15px; -webkit-tap-highlight-color: transparent; }
        
        #app-content { display: none; }
        #toast { position: fixed; top: 20px; right: 20px; background: var(--fg); color: var(--surface); padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: var(--shadow); display: none; z-index: 2000; border-left: 5px solid var(--accent); }

        /* HEADER & TABS */
        header.top { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
        .tabs-container { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.5rem 1rem; overflow-x: auto; position: sticky; top: 65px; z-index: 90; }
        .tabs { display: flex; gap: 6px; width: max-content; }
        .tabs button { padding: 8px 14px; border: 1px solid transparent; background: transparent; color: var(--muted); font-weight: 600; font-size: 0.85rem; border-radius: 8px; cursor: pointer; white-space: nowrap; }
        .tabs button.active { background: var(--panel); color: var(--accent); border-color: var(--border); }

        body.role-restricted .admin-only { display: none !important; }
        body.role-restricted .tabs button:not([data-tab="actividad"]) { display: none !important; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 1rem; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.2rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; overflow: hidden; }
        
        /* HERRAMIENTAS ADMIN */
        .admin-tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; background: var(--panel); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; }
        
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.3s ease; }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border); }
        .table { width: 100%; border-spacing: 0; border-collapse: separate; background: var(--card); min-width: 600px; }
        .table th { background: var(--panel); color: var(--muted); font-size: 0.75rem; font-weight: 800; padding: 10px; text-align: left; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        
        /* BOTONES E INPUTS */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--surface); color: var(--fg); gap: 6px; font-size: 0.85rem; }
        .btn.primary { background: var(--accent); color: white; border: none; }
        .btn.success { background: var(--success); color: white; border: none; }
        .btn.danger { background: var(--danger); color: white; border: none; }
        .btn.warning { background: var(--warning); color: white; border: none; }
        .btn.cloud { background: #8b5cf6; color: white; border: none; }
        
        input, select { background: var(--surface); border: 1px solid var(--border); padding: 8px; border-radius: 6px; color: var(--fg); font-size: 0.9rem; width: 100%; }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: var(--muted); margin-bottom: 3px; text-transform: uppercase; }

        /* Login Modal */
        #modalAuth { position: fixed; inset: 0; background: rgba(0,0,0,0.96); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        
        /* --- ESTILOS RESUMEN "DASHBOARD COMPACTO" --- */
        .stat-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 12px; 
        }
        .stat-block { 
            background: var(--card); 
            border: 1px solid var(--border); 
            padding: 12px; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.05); 
            border-left: 4px solid var(--accent); /* Borde lateral en lugar de superior para look 'tarjeta' */
        }
        .stat-block:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgb(0 0 0 / 0.1); transition: 0.2s; }
        .stat-block h4 { 
            color: var(--muted); 
            margin-bottom: 8px; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            font-weight: 800; 
            border-bottom: 1px solid var(--panel); 
            padding-bottom: 4px;
        }
        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px; 
            font-size: 0.85rem; 
        }
        .stat-value { 
            font-weight: 700; 
            font-size: 0.95rem; 
            color: var(--fg); 
            background: var(--panel);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ASISTENCIA */
        .asist-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 15px; }
        .asist-col h4 { color: var(--accent); margin-bottom: 8px; border-bottom: 2px solid var(--border); padding-bottom: 4px; font-size: 0.9rem; }

        /* PDF CLEAN STYLE */
        #preview-viewport, #s88-preview-viewport { padding: 0; background: transparent; display:flex; flex-direction:column; align-items:center; margin-top: 20px; }
        .print-canvas { width: 190mm; min-width: 190mm; background: #ffffff !important; color: #000; padding: 10mm; border: 2px solid #000; font-family: 'Inter', sans-serif; margin-bottom: 0; page-break-after: always; break-after: page; box-shadow: none !important; }
        .official-table { width: 100%; border-collapse: collapse !important; border: 1.5px solid #000 !important; margin-top: 5px; }
        .official-table th, .official-table td { border: 1.2px solid #000 !important; padding: 4px; font-size: 8.5pt; text-align: center; color: #000; }
        .official-table th { background: #f2f2f2 !important; font-weight: 800; }
        .s21-header-box { border: 1px solid #000; padding: 10px; margin-bottom: 10px; font-size: 9pt; line-height: 1.5; }
        
        @media (max-width: 768px) {
            header.top { flex-direction: column; align-items: stretch; gap: 10px; }
            .admin-tools-grid { grid-template-columns: 1fr; } 
            .asist-grid-layout { grid-template-columns: 1fr; }
            .stat-grid { grid-template-columns: 1fr 1fr; } /* 2 columnas en movil */
        }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="modalAuth">
    <div class="card" style="width:360px; max-width:90%; text-align:center;">
        <h2 style="font-weight:900; margin-bottom:12px;">Acceso Unificado</h2>
        <p style="font-size:0.85rem; color:var(--muted); margin-bottom:20px;">Ingresa tu clave de Administrador o de Grupo</p>
        <input type="password" id="mPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; font-size:2.2rem; letter-spacing:12px; margin-bottom:25px;">
        <button class="btn primary" id="mEnter" style="width:100%;">ENTRAR</button>
    </div>
</div>

<div id="app-content">
    <header class="top">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="background:var(--accent); width:32px; height:32px; border-radius:8px;"></div>
            <div>
                <h1 style="font-size: 1.1rem; font-weight: 800;">Congregaci√≥n Pro</h1>
                <span id="roleBadge" style="font-size:0.75rem; background:var(--panel); padding:2px 6px; border-radius:4px;">Modo: --</span>
            </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button class="btn success admin-only" id="btnSyncCloud">‚òÅÔ∏è Recibir Informes</button>
            
            <button class="btn warning" onclick="$('#fileInputSatelite').click()">üì• Cargar Archivo</button>
            <input type="file" id="fileInputSatelite" style="display:none;" accept=".json" onchange="handleImport(event)">
            
            <button class="btn cloud satellite-only" id="btnSendCloud" style="display:none;" onclick="sendToCloud()">‚òÅÔ∏è Enviar Informe</button>
            
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="number" id="headerYear" style="width:70px; padding:8px;">
                <select id="headerMonth" style="width:110px; padding:8px;"></select>
            </div>
            <button class="btn danger" onclick="location.reload()">üîí Salir</button>
        </div>
    </header>

    <div class="tabs-container">
        <div class="tabs">
            <button data-tab="personas" class="active admin-only">1. Miembros</button>
            <button data-tab="actividad" id="tabActividad">2. Informes</button>
            <button data-tab="asistencia" class="admin-only">3. Asistencia</button>
            <button data-tab="precursores" class="admin-only">4. Precursores</button>
            <button data-tab="tarjeta" class="admin-only">5. S-21-S</button>
            <button data-tab="s88" class="admin-only">6. S-88-S</button>
            <button data-tab="resumen" class="admin-only">7. Resumen</button>
            <button data-tab="sacados" class="admin-only" style="color:var(--danger)">8. Sacados</button>
            <button data-tab="inactivos" class="admin-only" style="color:var(--warning)">9. Inactivos</button>
        </div>
    </div>

    <div class="container">
        <section id="personas" class="tab active admin-only">
            <div class="card">
                <h3>Gesti√≥n de Miembros</h3>
                <div class="admin-tools-grid">
                    <input type="hidden" id="pId">
                    <div><label>Nombre</label><input type="text" id="pNombre" placeholder="Ej: Juan P√©rez"></div>
                    <div><label>Grupo</label><select id="pGrupo"><option value="1">G1</option><option value="2">G2</option><option value="3">G3</option><option value="4">G4</option><option value="5">G5</option></select></div>
                    <div><label>Sexo</label><select id="pSexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                    <div><label>Esperanza</label><select id="pEsp"><option value="Otras ovejas">Otras ovejas</option><option value="Ungido">Ungido</option></select></div>
                </div>
                <div class="admin-tools-grid">
                    <div><label>Nacimiento</label><input type="date" id="pNac"></div>
                    <div><label>Bautismo</label><input type="date" id="pBau"></div>
                    <div><label>Fecha Expulsi√≥n</label><input type="date" id="pFSac"></div>
                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:5px;">
                        <button class="btn primary" id="btnSaveP">üíæ Guardar Miembro</button>
                        <div style="display:flex; gap:5px; width:100%;">
                            <button class="btn danger" id="btnDeleteP" style="display:none; flex:1;">üóëÔ∏è Eliminar</button>
                            <button class="btn" id="btnCancelEdit" onclick="resetPForm()" style="display:none; flex:1;">Cancelar</button>
                        </div>
                    </div>
                </div>
                <div class="admin-tools-grid" style="background:var(--panel);">
                    <div style="grid-column:1/-1; display:flex; gap:15px; flex-wrap:wrap;">
                        <label><input type="checkbox" id="pAnc"> Anciano</label>
                        <label><input type="checkbox" id="pSM"> SM</label>
                        <label><input type="checkbox" id="pPR"> PR</label>
                        <label><input type="checkbox" id="pPE"> PE</label>
                        <label><input type="checkbox" id="pMis"> Mis.</label>
                    </div>
                </div>
                <div class="admin-tools-grid">
                    <div style="grid-column: span 2;"><input type="search" id="qPersona" list="pList" placeholder="Buscar para editar..."></div>
                    <div style="grid-column:1/-1; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn primary" id="btnQEdit">‚úèÔ∏è Editar</button>
                        <button class="btn cloud" onclick="cloudFullBackupUpload()">‚òÅÔ∏è Subir Copia a Nube</button>
                        <button class="btn cloud" onclick="cloudFullBackupDownload()">‚òÅÔ∏è Restaurar desde Nube</button>
                        
                        <button class="btn" onclick="exportBackup()">üíæ Backup Local</button>
                        <button class="btn warning" onclick="$('#modalPwd').style.display='flex'">üîë Clave</button>
                        <button class="btn danger" onclick="if(confirm('¬øBorrar todo?')){localStorage.clear();location.reload();}">‚ö†Ô∏è Reset</button>
                    </div>
                </div>
                <datalist id="pList"></datalist>
            </div>
            
            <div class="card">
                <h3>Lista de Miembros</h3>
                <div class="table-container">
                    <table class="table" id="tblMiembros">
                        <thead><tr><th>Nombre</th><th>Grupo</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="actividad" class="tab">
            <div class="card">
                <h3 id="reportTitle">Registro de Informes</h3>
                <div class="admin-tools-grid">
                    <div><label>Mes</label><select id="actMonthSelect"></select></div>
                    <div><label>A√±o</label><input type="number" id="actYearInput"></div>
                    <div>
                        <label>Grupo</label>
                        <select id="selGInforme">
                            <option value="1">G1</option><option value="2">G2</option><option value="3">G3</option><option value="4">G4</option><option value="5">G5</option>
                        </select>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:5px;">
                        <button class="btn success admin-only" id="btnSaveReports">üíæ Guardar Cambios</button>
                        <div class="satellite-only" style="font-size:0.75rem; color:var(--muted);">* Los cambios se guardan en este dispositivo. Si la lista est√° vac√≠a, usa el bot√≥n <b>"Importar Datos"</b> para cargar el archivo Backup que te dio el secretario.</div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="tblActividad">
                        <thead><tr><th>Nombre</th><th>Part.</th><th>Horas</th><th>Cursos</th><th>P. Aux</th><th>Notas</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="asistencia" class="tab admin-only">
            <div class="card">
                <h3>Asistencia</h3>
                <div class="admin-tools-grid">
                    <div><label>Mes</label><select id="asistMonthSelect"></select></div>
                    <div><label>A√±o</label><input type="number" id="asistYearInput"></div>
                </div>
                <div class="asist-grid-layout">
                    <div class="asist-col">
                        <h4>Vida y Ministerio</h4>
                        <div id="contES"></div>
                    </div>
                    <div class="asist-col">
                        <h4>Reuni√≥n P√∫blica</h4>
                        <div id="contFS"></div>
                    </div>
                </div>
                <button class="btn success" id="btnSaveAsist" style="margin-top:20px; width:100%;">üíæ Guardar Asistencia</button>
            </div>
        </section>

        <section id="precursores" class="tab admin-only"><div class="card"><h3>Precursores</h3><div class="table-container"><table class="table" id="tblPrecursores"><tbody></tbody></table></div></div><div class="card" style="margin-top:20px;"><h3>P. Auxiliares</h3><div class="table-container"><table class="table" id="tblAuxiliares"><tbody></tbody></table></div></div></section>
        <section id="tarjeta" class="tab admin-only"><div class="card"><h3>Tarjetas S-21</h3><div class="admin-tools-grid"><select id="s21Mode" onchange="toggleS21Inputs()"><option value="individual">Individual</option><option value="group">Por Grupo</option><option value="pr">Precursores</option><option value="all">Todos</option></select><div id="s21InputIndiv"><input id="s21Search" list="pList" placeholder="Nombre..."></div><div id="s21InputGroup" style="display:none;"><select id="s21GroupSel"><option value="1">G1</option><option value="2">G2</option><option value="3">G3</option><option value="4">G4</option><option value="5">G5</option></select></div><input type="number" id="s21Year" placeholder="A√±o"><button class="btn primary" onclick="previewS21()">Ver</button><button class="btn success" onclick="downloadPDFS21()">Descargar</button></div><div id="preview-viewport"></div></div></section>
        <section id="s88" class="tab admin-only"><div class="card"><h3>S-88</h3><div class="admin-tools-grid"><input type="number" id="s88Year"><button class="btn primary" onclick="renderS88Preview()">Ver</button><button class="btn primary" onclick="generatePDF('s88')">PDF</button></div><div id="s88-preview-viewport"></div></div></section>
        <section id="resumen" class="tab admin-only"><div class="card"><h3>Resumen</h3><div class="admin-tools-grid"><select id="resMonth"></select><input type="number" id="resYear"><button class="btn primary" id="btnSearchRes">Buscar</button></div><div id="resumenContent"></div></div></section>
        <section id="sacados" class="tab admin-only"><div class="card"><h3>Sacados</h3><div class="table-container"><table class="table" id="tblSacados"><thead><tr><th>Nombre</th><th>Bautismo</th><th>Fecha Salida</th></tr></thead><tbody></tbody></table></div></div></section>
        <section id="inactivos" class="tab admin-only"><div class="card"><h3>Inactivos (+6 Meses)</h3><div class="table-container"><table class="table" id="tblInactivos"><thead><tr><th>Nombre</th><th>G</th><th>√öltima Actividad</th><th>Tiempo Inactivo</th></tr></thead><tbody></tbody></table></div></div><div class="card" style="margin-top:20px;"><h3>Irregulares (A√±o Servicio)</h3><div class="table-container"><table class="table" id="tblIrregulares"><thead><tr><th>Nombre</th><th>G</th><th>Meses Fallados</th></tr></thead><tbody></tbody></table></div></div></section>
    </div>
</div>

<div id="modalPwd" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;">
    <div class="card" style="width:300px;">
        <h3>Nueva Clave Admin</h3>
        <input type="password" id="pNew">
        <button class="btn primary" onclick="updatePassword()" style="margin-top:10px; width:100%;">Guardar</button>
        <button class="btn" onclick="$('#modalPwd').style.display='none'" style="margin-top:5px; width:100%;">Cancelar</button>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN DE LA NUBE ---
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbz2h9AeXOftkTSim8in8PzJoWVGWJzzeEYtCVNswgeeIWEgqVNAvxzY-ZmqcHcnjmiQ/exec"; 
    
    const DB_KEY = 'cong_pro_v108_master';
    const $ = s => document.querySelector(s);
    const ymKey = (y,m) => `${y}-${String(m).padStart(2,'0')}`;
    const MESES_NOM = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const CICLO_S88 = [9,10,11,12,1,2,3,4,5,6,7,8];
    
    let state = { personas:[], activity:{}, attendance:{}, config: { pwd: '1728' } }; 
    let CURRENT_ROLE = 'ADMIN'; 
    const GROUP_PASSWORDS = { 'grupo1': '1', 'grupo2': '2', 'grupo3': '3', 'grupo4': '4', 'grupo5': '5' };

    let curY = new Date().getFullYear(), curM = new Date().getMonth()+1;
    let actY = curY, actM = curM, asistY = curY, asistM = curM;

    function init() {
        $('#mEnter').onclick = attemptLogin;
        $('#mPwd').onkeydown = (e) => { if(e.key==='Enter') attemptLogin(); };
        
        const mSels = [$('#headerMonth'), $('#actMonthSelect'), $('#resMonth'), $('#asistMonthSelect')];
        mSels.forEach(sel => { if(sel){ sel.innerHTML=''; MESES_NOM.forEach((m,i)=>{const o=document.createElement('option'); o.value=i+1; o.text=m; if(i+1===curM)o.selected=true; sel.appendChild(o);}); } });
        
        if($('#headerYear')) $('#headerYear').value = curY;
        if($('#actYearInput')) $('#actYearInput').value = curY;
        if($('#asistYearInput')) $('#asistYearInput').value = curY;
        if($('#resYear')) $('#resYear').value = curY;
        if($('#s21Year')) $('#s21Year').value = (curM>=9)?curY:curY-1;
        if($('#s88Year')) $('#s88Year').value = (curM>=9)?curY:curY-1;
        
        if($('#headerMonth')) $('#headerMonth').onchange = (e) => { curM=parseInt(e.target.value); renderAll(); };
        if($('#headerYear')) $('#headerYear').onchange = (e) => { curY=parseInt(e.target.value); renderAll(); };
        if($('#selGInforme')) $('#selGInforme').onchange = renderActividad;
        if($('#actMonthSelect')) $('#actMonthSelect').onchange = (e) => { actM=parseInt(e.target.value); renderActividad(); };
        if($('#actYearInput')) $('#actYearInput').onchange = (e) => { actY=parseInt(e.target.value); renderActividad(); };
        if($('#asistMonthSelect')) $('#asistMonthSelect').onchange = (e) => { asistM=parseInt(e.target.value); renderAsistInputs(); };
        if($('#asistYearInput')) $('#asistYearInput').onchange = (e) => { asistY=parseInt(e.target.value); renderAsistInputs(); };
        if($('#btnSearchRes')) $('#btnSearchRes').onclick = () => renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
        
        if($('#btnSaveP')) $('#btnSaveP').onclick = savePersona;
        if($('#btnDeleteP')) $('#btnDeleteP').onclick = deletePersona;
        if($('#btnQEdit')) $('#btnQEdit').onclick = () => { const n=$('#qPersona').value; const p=state.personas.find(x=>x.nombre===n); if(p) editP(p.id); };
        if($('#fileInputJSON')) $('#fileInputJSON').onchange = handleImport;
        if($('#btnSyncCloud')) $('#btnSyncCloud').onclick = cloudSyncAdmin;
        if($('#btnSaveReports')) $('#btnSaveReports').onclick = () => { save(); showToast("Guardado"); };
        if($('#btnSaveAsist')) $('#btnSaveAsist').onclick = () => { save(); showToast("Asistencia Guardada"); renderS88Preview(); };
        
        document.querySelectorAll('.tabs button').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.tabs button, .tab').forEach(el=>el.classList.remove('active'));
                b.classList.add('active');
                if($(`#${b.dataset.tab}`)) $(`#${b.dataset.tab}`).classList.add('active');
                if(b.dataset.tab === 'actividad') renderActividad();
                if(b.dataset.tab === 'asistencia') renderAsistInputs();
                if(b.dataset.tab === 'precursores') { renderPrecursores(); renderAuxiliares(); }
                if(b.dataset.tab === 'resumen') renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
                if(b.dataset.tab === 'sacados') renderSacados();
                if(b.dataset.tab === 'inactivos') renderEstadoEspiritual();
                if(b.dataset.tab === 'tarjeta') updateDatalist();
            };
        });
    }

    function attemptLogin() {
        const pwd = $('#mPwd').value;
        const adminPwd = (state.config && state.config.pwd) ? state.config.pwd : '1728';
        if (pwd === adminPwd) { CURRENT_ROLE = 'ADMIN'; enterApp(); } 
        else if (GROUP_PASSWORDS[pwd]) { CURRENT_ROLE = 'G' + GROUP_PASSWORDS[pwd]; enterApp(); } 
        else { alert("Clave incorrecta"); }
    }

    function enterApp() {
        $('#modalAuth').style.display = 'none';
        $('#app-content').style.display = 'block';
        document.body.className = (CURRENT_ROLE === 'ADMIN') ? 'role-admin' : 'role-restricted';
        $('#roleBadge').innerText = (CURRENT_ROLE === 'ADMIN') ? 'Modo: Administrador' : `Modo: Grupo ${CURRENT_ROLE.replace('G','')}`;
        if (CURRENT_ROLE !== 'ADMIN') {
            const grpNum = CURRENT_ROLE.replace('G', '');
            $('#selGInforme').value = grpNum;
            $('#selGInforme').disabled = true;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            $('#actividad').classList.add('active');
            $('.satellite-only').style.display = 'inline-flex';
        }
        renderAll();
    }

    try { const saved = localStorage.getItem(DB_KEY); if(saved) state = JSON.parse(saved); } catch(e) { console.error(e); }
    if(!state.personas) state.personas = [];
    if(!state.config) state.config = { pwd: '1728' }; 
    if(!state.activity) state.activity = {};
    if(!state.attendance) state.attendance = {};

    async function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); updateDatalist(); }

    async function sendToCloud() {
        if(CLOUD_URL.includes("PEGAR")) return alert("URL no configurada");
        if(!confirm("¬øEnviar informe a la nube?")) return;
        const grp = $('#selGInforme').value;
        const btn = $('#btnSendCloud');
        btn.textContent = "‚è≥ Enviando...";
        const exportObj = { type: 'satelite_data', generated: new Date().toISOString(), group: grp, month: actM, year: actY, activity: state.activity };
        try { await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(exportObj) }); alert("‚úÖ Informe enviado al secretario."); } 
        catch(e) { alert("Error de conexi√≥n"); } finally { btn.textContent = "‚òÅÔ∏è Enviar Informe"; }
    }

    async function cloudSyncAdmin() {
        if(CLOUD_URL.includes("PEGAR")) return alert("URL no configurada");
        const btn = $('#btnSyncCloud');
        btn.textContent = "‚è≥ Buscando...";
        try {
            const r = await fetch(CLOUD_URL);
            const data = await r.json();
            if(Array.isArray(data) && data.length > 0) {
                let count = 0;
                data.forEach(report => {
                    if(report.activity) {
                        Object.keys(report.activity).forEach(mKey => {
                            if(!state.activity[mKey]) state.activity[mKey] = {};
                            Object.assign(state.activity[mKey], report.activity[mKey]);
                        });
                        count++;
                    }
                });
                save(); renderActividad();
                await fetch(CLOUD_URL + "?action=clear");
                alert(`‚úÖ Se importaron ${count} informes de grupos.`);
            } else { alert("No hay informes nuevos en la nube."); }
        } catch(e) { alert("Error al sincronizar: " + e.message); } finally { btn.textContent = "‚òÅÔ∏è Recibir Informes"; }
    }

    // --- NUEVAS FUNCIONES DE RESPALDO EN LA NUBE ---
    async function cloudFullBackupUpload() {
        if(!confirm("¬øSubir copia de seguridad completa a la nube? (Sobrescribir√° la anterior)")) return;
        const btn = event.target; btn.textContent = "‚è≥ Subiendo...";
        try {
            const payload = { type: 'full_backup', generated: new Date().toISOString(), payload: state };
            await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            alert("‚úÖ Copia de seguridad subida a la nube.");
        } catch(e) { alert("Error: " + e.message); } finally { btn.textContent = "‚òÅÔ∏è Subir Copia a Nube"; }
    }

    async function cloudFullBackupDownload() {
        if(!confirm("‚ö†Ô∏è ¬øRestaurar base de datos desde la nube? ESTO BORRAR√Å LOS DATOS LOCALES ACTUALES.")) return;
        const btn = event.target; btn.textContent = "‚è≥ Descargando...";
        try {
            const r = await fetch(CLOUD_URL + "?action=get_db");
            const data = await r.json();
            if(data && data.personas) {
                state = data;
                save();
                renderAll();
                alert("‚úÖ Base de datos restaurada correctamente.");
            } else {
                alert("‚ùå No se encontr√≥ una copia v√°lida en la nube.");
            }
        } catch(e) { alert("Error: " + e.message); } finally { btn.textContent = "‚òÅÔ∏è Restaurar desde Nube"; }
    }

    function renderAll() {
        if(CURRENT_ROLE === 'ADMIN') { renderMiembros(); renderSacados(); renderEstadoEspiritual(); renderPrecursores(); renderAuxiliares(); renderAsistInputs(); }
        renderActividad();
        updateDatalist();
    }

    function renderActividad() {
        const g = $('#selGInforme').value;
        const tb = $('#tblActividad tbody');
        const k = ymKey(actY, actM);
        tb.innerHTML = '';
        state.personas.filter(p => p.grupo == g && !p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p => {
            const r = state.activity[k]?.[p.id] || {part:false, horas:0, est:0, pa:false, nota:''};
            tb.innerHTML += `<tr><td>${p.nombre}</td><td><input type="checkbox" ${r.part?'checked':''} onchange="updAct('${p.id}','part',this.checked)"></td><td><input type="number" value="${r.horas}" onchange="updAct('${p.id}','horas',this.value)" style="width:50px"></td><td><input type="number" value="${r.est}" onchange="updAct('${p.id}','est',this.value)" style="width:50px"></td><td><input type="checkbox" ${r.pa?'checked':''} onchange="updAct('${p.id}','pa',this.checked)"></td><td><input type="text" value="${r.nota||''}" onchange="updAct('${p.id}','nota',this.value)" style="width:100px"></td></tr>`;
        });
        if(tb.innerHTML === '') tb.innerHTML = `<tr><td colspan="6" style="padding:20px; color:var(--muted);">No hay miembros en el Grupo ${g} o faltan cargar los datos.</td></tr>`;
    }

    function updateDatalist() { const l=$('#pList'); if(l){ l.innerHTML = ''; state.personas.forEach(p => l.innerHTML += `<option value="${p.nombre}">`); } }
    function showToast(m) { const t=$('#toast'); t.textContent="‚úî "+m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    window.updAct = (pid, f, v) => { const k = ymKey(actY, actM); if(!state.activity[k]) state.activity[k] = {}; if(!state.activity[k][pid]) state.activity[k][pid] = {part:false, horas:0, est:0, pa:false}; state.activity[k][pid][f] = (f==='pa'||f==='part'||f==='nota') ? v : parseFloat(v||0); save(); }
    
    // --- FUNCIONES ADMIN ---
    function savePersona() { 
        const id=$('#pId').value, n=$('#pNombre').value.trim(); 
        if(!n) return alert("Nombre obligatorio"); 
        const data={ id:id||'p'+Date.now(), nombre:n, grupo:$('#pGrupo').value, sexo:$('#pSexo').value, esp:$('#pEsp').value, nac:$('#pNac').value, bau:$('#pBau').value, fsac:$('#pFSac').value, pr:$('#pPR').checked, anciano:$('#pAnc').checked, sm:$('#pSM').checked, pe:$('#pPE').checked, mis:$('#pMis').checked, sacado:!!$('#pFSac').value }; 
        if(id) state.personas[state.personas.findIndex(x=>x.id===id)]=data; else state.personas.push(data); 
        save(); renderMiembros(); resetPForm(); 
    }
    
    function deletePersona() { 
        const id=$('#pId').value; 
        if(!id)return; 
        if(confirm("¬øEliminar?")) { state.personas=state.personas.filter(p=>p.id!==id); save(); renderMiembros(); resetPForm(); } 
    }
    
    function resetPForm() { 
        $('#pId').value=''; $('#pNombre').value=''; 
        ['pNac','pBau','pFSac','pSexo','pEsp'].forEach(id=>$('#'+id).value=''); 
        ['pAnc','pSM','pPE','pMis','pPR'].forEach(id=>$('#'+id).checked=false); 
        $('#btnCancelEdit').style.display='none'; $('#btnDeleteP').style.display='none'; 
        $('#btnSaveP').textContent = 'üíæ Guardar Miembro';
    }
    
    function renderMiembros() { 
        const tb=$('#tblMiembros tbody'); if(!tb)return; tb.innerHTML=''; 
        state.personas.sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p=>{ 
            const tr=document.createElement('tr'); 
            if(p.sacado) tr.className='row-sacado'; 
            tr.innerHTML=`<td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td><button class="btn primary" onclick="editP('${p.id}')">‚úèÔ∏è</button></td>`; 
            tb.appendChild(tr); 
        }); 
    }
    
    window.editP = (id) => { 
        const p = state.personas.find(x=>x.id===id); 
        if(!p) return; 
        $('#pId').value = p.id; 
        $('#pNombre').value = p.nombre; 
        $('#pSexo').value = p.sexo; 
        $('#pEsp').value = p.esp; 
        $('#pNac').value = p.nac || ''; 
        $('#pBau').value = p.bau || ''; 
        $('#pFSac').value = p.fsac || ''; 
        $('#pPR').checked = !!p.pr; 
        $('#pAnc').checked = !!p.anciano; 
        $('#pSM').checked = !!p.sm; 
        $('#pPE').checked = !!p.pe; 
        $('#pMis').checked = !!p.mis; 
        $('#btnCancelEdit').style.display='inline-flex'; 
        $('#btnDeleteP').style.display='inline-flex'; 
        $('#btnSaveP').textContent = 'üíæ Actualizar Miembro';
        window.scrollTo(0,0); 
    }
    
    function handleImport(e) { 
        const input = e.target;
        const f = input.files[0]; 
        if(!f) return;
        
        if(!confirm("‚ö†Ô∏è ¬øCargar este archivo y reemplazar la base de datos actual?")) {
            input.value = ''; 
            return;
        } 
        
        const r = new FileReader(); 
        r.onload = (ev) => { 
            try { 
                const newData = JSON.parse(ev.target.result); 
                if(newData && newData.personas) {
                    state = newData; 
                    save(); 
                    renderAll(); 
                    alert("‚úÖ Base de datos cargada con √©xito."); 
                } else {
                    alert("‚ùå El archivo no parece ser un respaldo v√°lido.");
                }
            } catch(ex) { 
                alert("‚ùå Error al leer el archivo JSON: " + ex.message); 
            } finally {
                input.value = ''; 
            }
        }; 
        r.readAsText(f); 
    }

    function exportBackup() { const blob=new Blob([JSON.stringify(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function updatePassword() { if(!state.config) state.config={}; state.config.pwd=$('#pNew').value; save(); $('#modalPwd').style.display='none'; alert("Clave admin actualizada"); }
    function renderSacados() { const tb=$('#tblSacados tbody'); const c=$('#totalSacados'); if(!tb)return; tb.innerHTML=''; const l=state.personas.filter(p=>p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)); if(c)c.innerText=l.length; l.forEach(p=>{ tb.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.bau||'-'}</td><td style="color:var(--danger)">${p.fsac||'-'}</td></tr>`; }); }
    
    function renderEstadoEspiritual() { 
        const tbIn=$('#tblInactivos tbody'), cIn=$('#totalInactivos'), tbIrr=$('#tblIrregulares tbody'), cIrr=$('#totalIrregulares'); 
        if(!tbIn)return; 
        tbIn.innerHTML=''; tbIrr.innerHTML=''; 
        let nIn=0, nIrr=0; 
        const syStart = (curM>=9)?curY:curY-1; 
        
        state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p=>{ 
            let zeros=0, last='-'; 
            for(let i=0;i<36;i++){ 
                let ty=curY, tm=curM-i; 
                while(tm<=0){tm+=12;ty--;} 
                const act=state.activity[ymKey(ty,tm)]?.[p.id]; 
                if(act&&(act.horas>0||act.part)){ last=`${MESES_NOM[tm-1]} ${ty}`; break; } 
                else if(i<6) zeros++; 
            } 
            if(zeros>=6){ 
                nIn++; 
                tbIn.innerHTML+=`<tr><td>${p.nombre}</td><td>G${p.grupo}</td><td>${last}</td><td style="color:var(--danger)">+${zeros} meses</td></tr>`; 
            } else { 
                let fail=[]; 
                for(let i=1;i<=12;i++){ 
                    let ty=curY, tm=curM-i; 
                    while(tm<=0){tm+=12;ty--;} 
                    if(ty<syStart || (ty===syStart && tm<9)) break; 
                    const act=state.activity[ymKey(ty,tm)]?.[p.id]; 
                    if(!act||(!act.horas && !act.part)) fail.push(MESES_NOM[tm-1]); 
                } 
                if(fail.length>0){ 
                    nIrr++; 
                    tbIrr.innerHTML+=`<tr><td>${p.nombre}</td><td>G${p.grupo}</td><td style="color:var(--warning)">${fail.join(', ')}</td></tr>`; 
                } 
            } 
        }); 
        if(cIn)cIn.innerText=nIn; if(cIrr)cIrr.innerText=nIrr; 
    }

    function renderResumenMensual(y, m) { 
        const k=ymKey(y,m), act=state.activity[k]||{}, att=state.attendance[k]||{es:[],fs:[]}; 
        let tM=0,activos=0,pubC=0,pubE=0,prC=0,prH=0,prE=0,paC=0,paH=0,paE=0; 
        const last6=[]; for(let i=0;i<6;i++){let tm=m-i,ty=y; if(tm<=0){tm+=12;ty-=1;} last6.push(ymKey(ty,tm));} 
        
        state.personas.forEach(p=>{ 
            if(p.sacado)return; tM++; 
            let haInf=false; 
            for(const lk of last6){ if(state.activity[lk]?.[p.id]?.horas>0 || state.activity[lk]?.[p.id]?.part){ haInf=true; break; } } 
            if(haInf) activos++; 
            const r=act[p.id]||{}; 
            if(r.horas>0||r.part){ 
                const h=parseFloat(r.horas||0), e=parseInt(r.est||0); 
                if(p.pr){prC++;prH+=h;prE+=e;} else if(r.pa){paC++;paH+=h;paE+=e;} else{pubC++;pubE+=e;} 
            } 
        }); 
        const avgES=att.es.filter(n=>n>0).length?Math.round(att.es.reduce((a,b)=>a+b,0)/att.es.filter(n=>n>0).length):0; 
        const avgFS=att.fs.filter(n=>n>0).length?Math.round(att.fs.reduce((a,b)=>a+b,0)/att.fs.filter(n=>n>0).length):0; 
        
        $('#resumenContent').innerHTML=`
            <div class="stat-grid">
                <div class="stat-block"><h4>Totales</h4><div class="stat-row"><label>Miembros</label><span class="stat-value">${tM}</span></div><div class="stat-row"><label>Activos</label><span class="stat-value">${activos}</span></div></div>
                <div class="stat-block"><h4>Publicadores</h4><div class="stat-row"><label>Cant</label><span class="stat-value">${pubC}</span></div><div class="stat-row"><label>Est</label><span class="stat-value">${pubE}</span></div></div>
                <div class="stat-block"><h4>P. Regulares</h4><div class="stat-row"><label>Cant</label><span class="stat-value">${prC}</span></div><div class="stat-row"><label>Horas</label><span class="stat-value">${prH}</span></div><div class="stat-row"><label>Est</label><span class="stat-value">${prE}</span></div></div>
                <div class="stat-block"><h4>P. Auxiliares</h4><div class="stat-row"><label>Cant</label><span class="stat-value">${paC}</span></div><div class="stat-row"><label>Horas</label><span class="stat-value">${paH}</span></div><div class="stat-row"><label>Est</label><span class="stat-value">${paE}</span></div></div>
                <div class="stat-block"><h4>Asistencia Prom.</h4><div class="stat-row"><label>Vida y Min</label><span class="stat-value">${avgES}</span></div><div class="stat-row"><label>P√∫blica</label><span class="stat-value">${avgFS}</span></div></div>
            </div>`; 
    }

    function toggleS21Inputs() { const m=$('#s21Mode').value; $('#s21InputIndiv').style.display=(m==='individual')?'block':'none'; $('#s21InputGroup').style.display=(m==='group')?'block':'none'; $('#preview-viewport').innerHTML=''; }
    
    function getS21HTML(p,sy) { 
        let rows='',tH=0; 
        CICLO_S88.forEach(m=>{ 
            const y=(m>=9)?sy:sy+1, r=state.activity[ymKey(y,m)]?.[p.id]||{horas:0,est:0,pa:false,part:false}; 
            tH+=(r.horas||0); 
            rows+=`<tr><td>${MESES_NOM[m-1]}</td><td>${(r.horas||r.part)?'[X]':''}</td><td>${r.est||''}</td><td>${r.pa?'[X]':''}</td><td>${r.horas||''}</td><td></td></tr>`; 
        }); 
        
        // FULL INFO HEADER
        const privs = [p.anciano?'Anciano':'', p.sm?'Siervo Ministerial':'', p.pr?'Precursor Regular':'', p.pe?'Precursor Especial':'', p.mis?'Misionero':''].filter(Boolean).join(', ');
        
        return `<div class="print-canvas"><div class="print-title">REGISTRO DE PUBLICADOR DE LA CONGREGACI√ìN</div><div class="s21-header-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Nombre:</b> ${p.nombre}</span><span><b>Grupo:</b> ${p.grupo}</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Fecha Nacimiento:</b> ${p.nac||'-'}</span><span><b>Fecha Bautismo:</b> ${p.bau||'-'}</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Sexo:</b> ${p.sexo}</span><span><b>Esperanza:</b> ${p.esp}</span></div>
            <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><b>Privilegios:</b> ${privs || 'Publicador'}</div>
        </div><table class="official-table"><thead><tr><th>A√±o ${sy}-${sy+1}</th><th>Partic.</th><th>Estudios</th><th>P. Aux</th><th>Horas</th><th>Notas</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td colspan="4" style="text-align:right; font-weight:bold;">Total Horas:</td><td>${tH}</td><td></td></tr></tfoot></table><div style="margin-top:10px; font-size:0.7rem; text-align:right;">S-21-S</div></div>`; 
    }

    function getTargetList() { const m=$('#s21Mode').value; if(m==='individual'){const n=$('#s21Search').value; const p=state.personas.find(x=>x.nombre===n); return p?[p]:[];} if(m==='group'){return state.personas.filter(p=>p.grupo==$('#s21GroupSel').value && !p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));} if(m==='pr'){return state.personas.filter(p=>p.pr&&!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));} return state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)); }
    function previewS21() { const l=getTargetList(), sy=$('#s21Year').value; $('#preview-viewport').innerHTML=l.map(p=>getS21HTML(p,parseInt(sy))).join(''); }
    function downloadPDFS21() { const l=getTargetList(), sy=$('#s21Year').value; if(l.length===0)return alert("Sin datos"); const div=document.createElement('div'); div.innerHTML=l.map(p=>getS21HTML(p,parseInt(sy))).join(''); html2pdf().set({margin:0,filename:'S21_Reporte.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:1.5},jsPDF:{unit:'mm',format:'a4'}}).from(div).save(); }
    
    // --- FUNCI√ìN ASISTENCIA (CORREGIDA) ---
    function renderAsistInputs() { 
        const k=ymKey(asistY,asistM); 
        if(!state.attendance[k]) state.attendance[k]={es:[0,0,0,0,0,0],fs:[0,0,0,0,0,0]}; 
        
        const cES=$('#contES'), cFS=$('#contFS'); 
        cES.innerHTML=''; cFS.innerHTML=''; 
        
        for(let i=0;i<6;i++){ 
            cES.innerHTML+=`<div style="margin-bottom:8px;"><label>Sem ${i+1}</label><input type="number" value="${state.attendance[k].es[i]||0}" oninput="updAsist('es',${i},this.value)"></div>`; 
            cFS.innerHTML+=`<div style="margin-bottom:8px;"><label>Sem ${i+1}</label><input type="number" value="${state.attendance[k].fs[i]||0}" oninput="updAsist('fs',${i},this.value)"></div>`; 
        } 
    }
    
    window.updAsist=(t,i,v)=>{ const k=ymKey(asistY,asistM); state.attendance[k][t][i]=parseInt(v||0); save(); };
    function buildS88TableContent(sy, t) { let rows='',tA=0,tR=0; CICLO_S88.forEach(m=>{ const y=(m>=9)?sy:sy+1; const d=state.attendance[ymKey(y,m)]?.[t]||[0,0,0,0,0,0]; const re=d.filter(v=>v>0).length; const as=d.reduce((a,b)=>a+b,0); const pr=re>0?Math.round(as/re):''; tA+=as; tR+=re; rows+=`<tr><td style="text-align:left">${MESES_NOM[m-1]}</td><td>${re||''}</td><td>${as||''}</td><td>${pr}</td></tr>`; }); const avg=tR>0?Math.round(tA/tR):''; return {h:rows,avg:avg}; }
    function renderS88Preview() { const sy=parseInt($('#s88Year').value); const es=buildS88TableContent(sy,'es'); const fs=buildS88TableContent(sy,'fs'); $('#s88-preview-viewport').innerHTML=`<div class="print-canvas"><div class="print-title">REGISTRO DE ASISTENCIA</div><div style="font-weight:800; margin:10px 0;">Entre semana</div><table class="official-table"><thead><tr><th>A√±o ${sy}-${sy+1}</th><th>Reuniones</th><th>Asistencia</th><th>Promedio</th></tr></thead><tbody>${es.h}</tbody><tfoot><tr style="font-weight:bold;"><td style="text-align:right">Promedio</td><td colspan="2"></td><td>${es.avg}</td></tr></tfoot></table><div style="font-weight:800; margin:20px 0 10px;">Fin de semana</div><table class="official-table"><thead><tr><th>A√±o ${sy}-${sy+1}</th><th>Reuniones</th><th>Asistencia</th><th>Promedio</th></tr></thead><tbody>${fs.h}</tbody><tfoot><tr style="font-weight:bold;"><td style="text-align:right">Promedio</td><td colspan="2"></td><td>${fs.avg}</td></tr></tfoot></table></div>`; }
    function renderPrecursores() { const tb=$('#tblPrecursores tbody'); if(!tb)return; tb.innerHTML=''; state.personas.filter(p=>p.pr&&!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p=>{ tb.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${p.bau||'-'}</td><td style="color:var(--success)">Activo</td></tr>`; }); }
    function renderAuxiliares() { const tb=$('#tblAuxiliares tbody'), k=ymKey(curY,curM); if(!tb)return; tb.innerHTML=''; state.personas.filter(p=>!p.sacado&&state.activity[k]?.[p.id]?.pa).forEach(p=>{ tb.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${state.activity[k][p.id].horas}</td></tr>`; }); }

    window.addEventListener("DOMContentLoaded", () => { try { init(); } catch(e) { alert("Error: " + e.message); } });
</script>
</body>
</html>
